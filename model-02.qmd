---
title: "Thesis - Model"
toc: true
number-sections: true
code-fold: true
warning: false
output: false
error: true
format: gfm
editor_options: 
  markdown: 
    wrap: sentence
---
After failing to come up with meaningful results in model-01 attempt with a linear regression model predicting approved budget, we will now examine the different parameters correlated with varying degrees of SELA budget usage.

# Load libraries

```{r}
library(tidyverse)
library(tidymodels)
library(modelr)
library(corrr)
library(ggfortify)
```

# Selecting relevant variables
```{r}
sela_df <- df %>% 
  select(
    name,
    muni_id,
    district,
    type,
    pop,
    pop_2015,
    likud_pct,
    coal_pct,
    ses_2013_c,
    peri_2004_c,
    sa_data,
    sector,
    is_nat_pri,
    starts_with("budget")
  )
```

# Checking eligibility for both SELA budget types

## Festival eligibility
The population year determined to use to decide eligibility is 2015. using 2018 created some municipalities that changed population category between the years. the 2015 year was the latest available during the start of 2018.
```{r}
sela_df <- sela_df %>% 
  mutate(
    is_elig_fest = case_when(
      pop_2015 > 100000 ~ FALSE,
      ses_2013_c > 7 ~ FALSE,
      ses_2013_c < 7 ~ TRUE,
      type == "מועצה אזורית" & peri_2004_c <= 2 ~ TRUE,
      is_nat_pri ~ TRUE,
      TRUE ~ FALSE
    ),
    budget_elig_fest = case_when(
      !is_elig_fest ~ 0,
      pop_2015 <= 5000 ~ 70000,
      pop_2015 <= 20000 ~ 115000,
      pop_2015 > 20000 ~ 200000
    )
  )

sela_df %>% 
  ggplot(aes(budget_approved_fest/budget_elig_fest)) +
  geom_histogram()

sela_df %>% 
  filter(!is_elig_fest & budget_approved_fest > 0)

sela_df %>% 
  filter(is_elig_fest & budget_approved_fest < budget_elig_fest)

```
Right now it seems we have two municipalities that are seemingly not eligible for festivals but got budgeted: Hof Ashkelon and Beit Shemesh.

## Initiatives eligibility

The eligibility score of each municipality is calculated: first the unbudgeted municipalities are filtered out and then the score is calculated according the the regulations. the score is normalized between all eligible municipalities and then multiplied by a number close to the total budget allocated. the specific number was decided through trial and error to match the vast majority of municipalities. A ration between potential budget and score is calculated. Finally, summary charts and tables are presented.
```{r}
sela_df <- sela_df %>% 
  mutate(
    score_elig_init = case_when(
      budget_approved_init == 0 ~ 0,
      pop_2015 <= 10000 ~ 1,
      pop_2015 <= 50000 ~ 2,
      pop_2015 <= 100000 ~ 3,
      pop_2015 <= 150000 ~ 4,
      pop_2015 <= 200000 ~ 5,
      pop_2015 <= 500000 ~ 6,
      pop_2015 > 500000 ~ 7
    ),
    score_elig_init = case_when(
      pop_2015 > 100000 ~ score_elig_init,
      is_nat_pri ~ score_elig_init * 2,
      ses_2013_c <= 6 ~ score_elig_init * 2,
      peri_2004_c <= 2 ~ score_elig_init * 2,
      TRUE ~ score_elig_init
    ),
    budget_elig_init = 23907075 * score_elig_init / sum(score_elig_init)
  )

ratio_elig_init <- sela_df %>% 
  summarize(budget_elig_init / score_elig_init) %>% 
  pull() %>% first()

sela_df %>% 
  ggplot(aes(budget_approved_init - budget_elig_init)) +
  geom_histogram()

sela_df %>% 
  count(budget_approved_init - budget_elig_init)

sela_df %>% 
  filter(budget_approved_init > budget_elig_init) %>% 
  arrange(desc(budget_approved_init - budget_elig_init))
```

After calculating the eligibility sum for all municipalities, a further calculation is required for unbudgeted municipalities, as they were filtered out of the previous section. each unbudgeted municipality is calculated a score and a potential budget, multiplied by the ratio calculated in the previous section.
```{r}
sela_df <- sela_df %>% 
  mutate(
    score_elig_init = case_when(
      budget_approved_init > 0 ~ score_elig_init,
      pop_2015 <= 10000 ~ 1,
      pop_2015 <= 50000 ~ 2,
      pop_2015 <= 100000 ~ 3,
      pop_2015 <= 150000 ~ 4,
      pop_2015 <= 200000 ~ 5,
      pop_2015 <= 500000 ~ 6,
      pop_2015 > 500000 ~ 7
    ),
    score_elig_init = case_when(
      budget_approved_init > 0 ~ score_elig_init,
      pop_2015 > 100000 ~ score_elig_init,
      is_nat_pri ~ score_elig_init * 2,
      ses_2013_c <= 6 ~ score_elig_init * 2,
      peri_2004_c <= 2 ~ score_elig_init * 2,
      TRUE ~ score_elig_init
    ),
    budget_elig_init = case_when(
      budget_approved_init > 0 ~ budget_elig_init,
      TRUE ~ score_elig_init * ratio_elig_init
    )
  )

```

